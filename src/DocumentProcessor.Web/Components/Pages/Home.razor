@page "/"
@using DocumentProcessor.Web.Models
@using DocumentProcessor.Web.Data
@using DocumentProcessor.Web.Services
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@inject AppDbContext DB
@inject FileStorageService Storage
@inject DocumentProcessingService Processor
@inject ILogger<Home> Logger
@inject DatabaseInfoService DbInfo
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Document Processor</PageTitle>

<div class="container-fluid mt-4 px-4 pb-5">
    <h1 class="mb-2 text-white">Document Processor</h1>
    <div class="welcome-note mb-3">
        <i class="bi bi-stars me-2"></i>Upload a doc and I will summarize it for you
    </div>
    @if (DbInfo.DatabaseType.Contains("PostgreSQL"))
    {
        <div class="db-banner db-banner-postgres mb-4">
            <img src="https://cdn.worldvectorlogo.com/logos/postgresql.svg" alt="PostgreSQL" class="db-logo me-3" />
            <span class="db-banner-text">
                <i class="bi bi-rocket-takeoff-fill me-2"></i>YOU DID IT !!! I am running on Amazon Aurora PostgreSQL!!!
            </span>
        </div>
    }
    else
    {
        <div class="db-banner db-banner-sql mb-4">
            <img src="https://cdn.worldvectorlogo.com/logos/microsoft-sql-server-1.svg" alt="SQL Server" class="db-logo me-3" />
            <span class="db-banner-text">
                <i class="bi bi-database-fill me-2"></i>I am running on SQL Server...
            </span>
        </div>
    }
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Documents</h5>
                    @if (_isLoading) { <div class="text-center p-3"><div class="spinner-border"></div></div> }
                    else if (!_documents.Any()) { <p class="text-muted text-center fs-5">No documents yet</p> }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead><tr><th>File</th><th>Status</th><th>Summary</th><th></th></tr></thead>
                                <tbody>
                                    @foreach (var doc in _documents)
                                    {
                                        <tr>
                                            <td><i class="bi @GetFileIcon(doc.FileExtension) me-2 file-icon"></i>@doc.FileName</td>
                                            <td>@GetStatusBadge(doc.Status)</td>
                                            <td class="summary-cell">@(doc.Summary ?? "-")</td>
                                            <td class="action-cell">
                                                <button class="btn btn-link" @onclick="RefreshPage"><i class="bi bi-arrow-clockwise action-icon"></i></button>
                                                @if (!string.IsNullOrEmpty(doc.Summary)) { <button class="btn btn-link" @onclick="() => ShowSummary(doc)"><i class="bi bi-eye-fill action-icon"></i></button> }
                                                <button class="btn btn-link text-danger" @onclick="() => ShowDelete(doc)"><i class="bi bi-trash3-fill action-icon"></i></button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Upload Documents</h5>
                    @foreach (var msg in _messages) { <div class="alert alert-@msg.Type alert-sm mt-2 py-1 mb-3"><small>@msg.Text</small></div> }
                    <div class="upload-area" @ondragenter="() => _isDragOver = true" @ondragleave="() => _isDragOver = false">
                        <div class="text-center p-2">
                            <i class="bi bi-cloud-arrow-up-fill" style="font-size: 3rem; color: #0d6efd; display: block; line-height: 1;"></i>
                            <p class="mt-2 mb-1">Drag files or click to browse</p>
                            <p class="small text-muted mb-1">Suggested: <code>C:\MAM319\DPS\docs</code></p>
                            <label for="fileInput" class="btn btn-primary mt-2" style="cursor: pointer;">
                                <i class="bi bi-folder2-open me-1"></i>Choose Files
                                <InputFile id="fileInput" OnChange="@LoadFiles" multiple accept=".pdf,.doc,.docx,.txt,.xlsx,.xls,.csv" style="display: none;" />
                            </label>
                        </div>
                    </div>
                    @if (_selectedFiles.Any())
                    {
                        <div class="mt-3">
                            <h6>Selected:</h6>
                            <ul class="list-group list-group-sm">
                                @foreach (var file in _selectedFiles)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-1">
                                        <small>@file.Name (@GetFileSize(file.Size))</small>
                                        <button class="btn btn-sm btn-danger py-0" @onclick="() => _selectedFiles.Remove(file)"><i class="bi bi-x"></i></button>
                                    </li>
                                }
                            </ul>
                            <div class="mt-2">
                                <button class="btn btn-primary" @onclick="UploadFiles" disabled="@_isUploading">
                                    @if (_isUploading) { <span class="spinner-border spinner-border-sm me-1"></span> <span>Uploading...</span> } else { <i class="bi bi-upload me-1"></i> <span>Upload</span> }
                                </button>
                                <button class="btn btn-secondary ms-1" @onclick="() => _selectedFiles.Clear()" disabled="@_isUploading">Clear</button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div class="db-info-footer">
    <div class="container-fluid px-4">
        <div class="d-flex justify-content-center align-items-center gap-4">
            <span><i class="bi bi-database-fill-check me-2 footer-icon"></i><strong>@DbInfo.DatabaseType</strong></span>
            <span class="text-muted">|</span>
            <span><i class="bi bi-shield-lock-fill me-2 footer-icon"></i>@DbInfo.SecretName</span>
            <span class="text-muted">|</span>
            <span><i class="bi bi-hdd-network-fill me-2 footer-icon"></i>@DbInfo.HostAddress</span>
        </div>
    </div>
</div>

@if (_showSummary && _selectedDoc != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" @onclick="CloseSummary">
        <div class="modal-dialog" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title">@_selectedDoc.FileName</h6>
                    <button type="button" class="btn-close" @onclick="CloseSummary"></button>
                </div>
                <div class="modal-body"><p>@_selectedDoc.Summary</p></div>
                <div class="modal-footer"><button class="btn btn-sm btn-secondary" @onclick="CloseSummary">Close</button></div>
            </div>
        </div>
    </div>
}

@if (_showDelete && _deleteDoc != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" @onclick="CloseDelete">
        <div class="modal-dialog modal-sm" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title">Delete?</h6>
                    <button type="button" class="btn-close" @onclick="CloseDelete"></button>
                </div>
                <div class="modal-body"><p><strong>@_deleteDoc.FileName</strong></p></div>
                <div class="modal-footer">
                    <button class="btn btn-sm btn-secondary" @onclick="CloseDelete" disabled="@_isDeleting">Cancel</button>
                    <button class="btn btn-sm btn-danger" @onclick="DeleteDoc" disabled="@_isDeleting">
                        @if (_isDeleting) { <span class="spinner-border spinner-border-sm"></span> } else { <span>Delete</span> }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    .upload-area { border: 2px dashed #dee2e6; border-radius: 0.25rem; background: #f8f9fa; }
    .upload-area:hover { border-color: #0d6efd; background: #e7f1ff; }
    .alert-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
    .card { border: none; border-radius: 0.5rem; }
    .shadow { box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important; }
    .table { margin-bottom: 0; font-size: clamp(0.875rem, 2vw, 1.25rem); }
    .table thead th { border-bottom: 2px solid #dee2e6; padding: clamp(0.5rem, 2vw, 1rem); font-weight: 600; }
    .table tbody td { padding: clamp(0.5rem, 2vw, 1rem); vertical-align: middle; }
    .summary-cell { max-width: clamp(150px, 30vw, 400px); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .action-cell { white-space: nowrap; width: clamp(80px, 15vw, 120px); }
    .db-info-footer { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 1rem 0; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); font-size: 0.9rem; color: #495057; z-index: 1000; }
    .welcome-note { background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1)); backdrop-filter: blur(10px); padding: 1rem 2rem; border-radius: 50px; color: white; font-size: 1.3rem; font-weight: 300; text-align: center; border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); display: inline-block; }
    .upload-icon { font-size: 4rem; color: #0d6efd; display: block; line-height: 1; }
    .file-icon { font-size: clamp(1.25rem, 3vw, 2rem); vertical-align: middle; line-height: 1; }
    .action-icon { font-size: clamp(1rem, 2.5vw, 1.5rem); line-height: 1; }
    .footer-icon { font-size: 1.3rem; vertical-align: middle; line-height: 1; }
    .status-badge-icon { font-size: clamp(1rem, 2.5vw, 1.4rem); line-height: 1; }
    .db-banner { padding: 0.8rem 1rem; border-radius: 12px; font-size: clamp(1rem, 2.5vw, 1.4rem); font-weight: 500; text-align: center; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); animation: slideDown 0.5s ease-out; line-height: 1.4; display: flex; align-items: center; justify-content: center; }
    .db-banner-postgres { background: linear-gradient(135deg, #10b981, #059669); color: white; border: 2px solid rgba(255, 255, 255, 0.3); }
    .db-banner-sql { background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15)); backdrop-filter: blur(10px); color: white; border: 2px solid rgba(255, 255, 255, 0.3); }
    .db-banner-text { display: inline-flex; align-items: center; }
    .db-logo { height: clamp(40px, 8vw, 60px); width: auto; object-fit: contain; }
    @@keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
</style>

@code {
    private List<IBrowserFile> _selectedFiles = [];
    private List<Document> _documents = [];
    private List<Message> _messages = [];
    private bool _isLoading = true, _isUploading, _isDragOver, _showSummary, _showDelete, _isDeleting;
    private Document? _selectedDoc, _deleteDoc;
    private const long MaxFileSize = 50 * 1024 * 1024;

    protected override async Task OnInitializedAsync() => await LoadDocuments();

    private async Task LoadDocuments()
    {
        _isLoading = true;
        StateHasChanged();
        try { _documents = await DB.Documents.Where(d => !d.IsDeleted).Take(50).ToListAsync(); }
        catch (Exception ex) { Logger.LogError(ex, "Load failed"); _documents = []; }
        finally { _isLoading = false; StateHasChanged(); }
    }

    private void RefreshPage() => Navigation.NavigateTo("/", forceLoad: true);

    private void LoadFiles(InputFileChangeEventArgs e)
    {
        _selectedFiles.Clear();
        _messages.Clear();
        var validExts = new[] { ".pdf", ".doc", ".docx", ".txt", ".xlsx", ".xls", ".csv" };
        foreach (var file in e.GetMultipleFiles(10))
        {
            if (file.Size > MaxFileSize) { AddMessage($"'{file.Name}' exceeds max size", "warning"); continue; }
            if (!validExts.Contains(Path.GetExtension(file.Name).ToLowerInvariant())) { AddMessage($"'{file.Name}' unsupported", "warning"); continue; }
            _selectedFiles.Add(file);
        }
        if (_selectedFiles.Any()) AddMessage($"Selected {_selectedFiles.Count} file(s)", "info");
    }

    private async Task UploadFiles()
    {
        if (!_selectedFiles.Any()) return;
        _isUploading = true;
        _messages.Clear();
        foreach (var file in _selectedFiles)
        {
            try
            {
                var doc = new Document
                {
                    Id = Guid.NewGuid(), FileName = file.Name, OriginalFileName = file.Name,
                    FileExtension = Path.GetExtension(file.Name).ToLowerInvariant(), ContentType = file.ContentType,
                    FileSize = file.Size, Status = DocumentStatus.Pending, UploadedBy = "System"
                };
                using var stream = file.OpenReadStream(MaxFileSize);
                doc.StoragePath = await Storage.SaveDocumentAsync(stream, file.Name);
                await DB.Documents.AddAsync(doc);
                await DB.SaveChangesAsync();
                try { await Processor.ProcessDocumentAsync(doc.Id); AddMessage($"'{file.Name}' uploaded", "success"); }
                catch (Exception ex) { Logger.LogError(ex, "Process failed"); AddMessage($"'{file.Name}' uploaded but process failed", "warning"); }
            }
            catch (Exception ex) { Logger.LogError(ex, "Upload failed"); AddMessage($"Failed '{file.Name}'", "danger"); }
        }
        _isUploading = false;
        _selectedFiles.Clear();
        await LoadDocuments();
    }

    private async Task DeleteDoc()
    {
        if (_deleteDoc == null) return;
        _isDeleting = true;
        try
        {
            DB.Documents.Remove(_deleteDoc);
            await DB.SaveChangesAsync();
            _documents.Remove(_deleteDoc);
            CloseDelete();
        }
        catch (Exception ex) { Logger.LogError(ex, "Delete failed"); }
        finally { _isDeleting = false; }
    }

    private void ShowSummary(Document doc) { _selectedDoc = doc; _showSummary = true; }
    private void CloseSummary() { _showSummary = false; _selectedDoc = null; }
    private void ShowDelete(Document doc) { _deleteDoc = doc; _showDelete = true; }
    private void CloseDelete() { _showDelete = false; _deleteDoc = null; }
    private void AddMessage(string text, string type) => _messages.Add(new Message { Text = text, Type = type });
    private string GetFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double size = bytes;
        int order = 0;
        while (size >= 1024 && order < 3) { order++; size /= 1024; }
        return $"{size:0.##} {sizes[order]}";
    }
    private string GetFileIcon(string ext) => ext.ToLower() switch
    {
        ".pdf" => "bi-file-pdf-fill text-danger",
        ".doc" or ".docx" => "bi-file-word-fill text-primary",
        ".xls" or ".xlsx" or ".csv" => "bi-file-excel-fill text-success",
        ".txt" => "bi-file-text-fill",
        _ => "bi-file-earmark-fill"
    };
    private RenderFragment GetStatusBadge(DocumentStatus status) => status switch
    {
        DocumentStatus.Processed => @<span class="badge bg-success" style="padding: 0.5rem 0.75rem;"><i class="bi bi-check-circle-fill status-badge-icon"></i></span>,
        DocumentStatus.Processing => @<span class="badge bg-warning" style="padding: 0.5rem 0.75rem;"><i class="bi bi-hourglass-split status-badge-icon"></i></span>,
        DocumentStatus.Failed => @<span class="badge bg-danger" style="padding: 0.5rem 0.75rem;"><i class="bi bi-x-circle-fill status-badge-icon"></i></span>,
        _ => @<span class="badge bg-secondary" style="padding: 0.5rem 0.75rem;"><i class="bi bi-clock-fill status-badge-icon"></i></span>
    };
    record Message { public string Text { get; set; } = ""; public string Type { get; set; } = "info"; }
}
